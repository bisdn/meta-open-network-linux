From 260a64eb0710bf9bcdbf63b38e4823f3642ee245 Mon Sep 17 00:00:00 2001
From: Jonas Gorski <jonas.gorski@bisdn.de>
Date: Tue, 15 Nov 2022 14:52:54 +0100
Subject: [PATCH 4/4] accton-as5835-54x: update i2c_driver with 6.1
 compatibility

i2c_remove changes its return type from int to void, so we need to
provide different versions based on kernel version.

Add variants using the following semantic patch:

// <smpl>
@r@
identifier DRIVER;
identifier remove_fn;
fresh identifier remove_fn_wrap = remove_fn ## "_6_1";
position p;
@@
struct i2c_driver DRIVER@p = {
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,1,0)
+     .remove = remove_fn_wrap,
+#else
      .remove = remove_fn,
+#endif
};

@i depends on r@
@@
#include <linux/version.h>
@depends on r&&!i@
@@
#include <...>
+#include <linux/version.h>
@depends on r@
identifier r.remove_fn;
identifier r.remove_fn_wrap;
@@
int remove_fn(...) {...}
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,1,0)
+static void remove_fn_wrap(struct i2c_Client *client)
+{
+     remove_fn(client);
+}
+#endif
// </smpl>

applied with

  spatch --smpl-spacing --sp-file 6.1-i2c_remove_sig.cocci --in-place --dir packages/

Result taken as is, without any code style fixes.

Signed-off-by: Jonas Gorski <jonas.gorski@bisdn.de>
---
 .../modules/builds/x86-64-accton-as5835-54x-cpld.c    | 10 ++++++++++
 .../modules/builds/x86-64-accton-as5835-54x-fan.c     | 11 +++++++++++
 .../modules/builds/x86-64-accton-as5835-54x-psu.c     | 11 +++++++++++
 3 files changed, 32 insertions(+)

diff --git a/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-cpld.c b/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-cpld.c
index b490e3a5b7a0..330fafa905e0 100644
--- a/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-cpld.c
+++ b/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-cpld.c
@@ -1086,6 +1086,12 @@ static int as5835_54x_cpld_remove(struct i2c_client *client)
 
     return 0;
 }
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,1,0)
+static void as5835_54x_cpld_remove_6_1(struct i2c_client *client)
+{
+    as5835_54x_cpld_remove(client);
+}
+#endif
 
 static int as5835_54x_cpld_read_internal(struct i2c_client *client, u8 reg)
 {
@@ -1177,7 +1183,11 @@ static struct i2c_driver as5835_54x_cpld_driver = {
 		.owner	= THIS_MODULE,
 	},
 	.probe		= as5835_54x_cpld_probe,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,1,0)
+	.remove = as5835_54x_cpld_remove_6_1,
+#else
 	.remove		= as5835_54x_cpld_remove,
+#endif
 	.id_table	= as5835_54x_cpld_id,
 };
 
diff --git a/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-fan.c b/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-fan.c
index d12cc7fabe19..9f5cbb8e45d1 100644
--- a/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-fan.c
+++ b/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-fan.c
@@ -30,6 +30,7 @@
 #include <linux/slab.h>
 #include <linux/dmi.h>
 #include <linux/platform_device.h>
+#include <linux/version.h>
 
 #define DRVNAME "as5835_54x_fan"
 #define MAX_FAN_SPEED_RPM	21500
@@ -463,6 +464,12 @@ static int as5835_54x_fan_remove(struct i2c_client *client)
     
     return 0;
 }
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,1,0)
+static void as5835_54x_fan_remove_6_1(struct i2c_client *client)
+{
+    as5835_54x_fan_remove(client);
+}
+#endif
 
 /* Addresses to scan */
 static const unsigned short normal_i2c[] = { I2C_CLIENT_END };
@@ -479,7 +486,11 @@ static struct i2c_driver as5835_54x_fan_driver = {
         .name     = DRVNAME,
     },
     .probe        = as5835_54x_fan_probe,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,1,0)
+    .remove = as5835_54x_fan_remove_6_1,
+#else
     .remove       = as5835_54x_fan_remove,
+#endif
     .id_table     = as5835_54x_fan_id,
     .address_list = normal_i2c,
 };
diff --git a/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-psu.c b/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-psu.c
index 81000e42abd0..2dabd25d5837 100644
--- a/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-psu.c
+++ b/packages/platforms/accton/x86-64/as5835-54x/modules/builds/x86-64-accton-as5835-54x-psu.c
@@ -33,6 +33,7 @@
 #include <linux/slab.h>
 #include <linux/delay.h>
 #include <linux/dmi.h>
+#include <linux/version.h>
 
 
 #define PSU_STATUS_I2C_ADDR			0x60
@@ -221,6 +222,12 @@ static int as5835_54x_psu_remove(struct i2c_client *client)
 	
 	return 0;
 }
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,1,0)
+static void as5835_54x_psu_remove_6_1(struct i2c_client *client)
+{
+	as5835_54x_psu_remove(client);
+}
+#endif
 
 enum psu_index 
 { 
@@ -241,7 +248,11 @@ static struct i2c_driver as5835_54x_psu_driver = {
 		.name	 = "as5835_54x_psu",
 	},
 	.probe		= as5835_54x_psu_probe,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,1,0)
+	.remove = as5835_54x_psu_remove_6_1,
+#else
 	.remove	   = as5835_54x_psu_remove,
+#endif
 	.id_table	 = as5835_54x_psu_id,
 	.address_list = normal_i2c,
 };
-- 
2.42.0

